# Навгация
1. [Главная](#мод-для-майнкрафта)  
  1.1 [Описание](#описание)  
  1.2 [Требования](#требования)  
  1.3 [Как в это играть?](#как-в-это-играть)
2. [Техническая часть](#техническая часть)  
  2.1 [Подготовка](#подготовка)  
  2.2 [Предисловие](#предисловие)  
  2.3 [Создание нового типа мира](#создание-нового-типа-мира)  
  2.4 [Шум и его настройки](#шум-и-его-настройки)

# Мод для Майнкрафта

## Описание
Мод, добавляющий в Майнкрафт новый тип мира - МИР-Н. В мире МИР-Н полностью изменена генерация ландшафта. МИР-Н состоит из гигантских вертикальных, изрезанных пещерами островов.
![Первый взгляд](readme_assets/mod_preview.png)

### Функционал
- **Переработанный ландшафт** и новое распределение биомов, сохраняющие функционал основной игры (все биомы, структуры, блоки и ресурсы из обычной игры могут натурально сгенерироваться в мире)
  - Многоуровневая генерация растительности всех биомов (раньше растения могли появляться процедурным путем только на поверхности)
  - Увеличена высота верхнего мира (раньше: от -64 до 320, теперь: от -256 до 256)
- Палки теперь работают как зубочистки
- Локализован на русском и английском языках

## Требования
- Майнкрафт Java Edition версии 1.20.1
- [Загрузчик модов Forge](https://files.minecraftforge.net/net/minecraftforge/forge/index_1.20.1.html "Forge") для версии 1.20.1

## Как в это играть?
1. Убедитесь, что все [требования]((#требования) выполнены;
2. Скачать из этого репозитория архив мода последней версии;
3. Установить мод ([как устанавливать моды](https://apexminecrafthosting.com/how-to-install-mods-on-forge/));
4. Перейти в меню "Создать новый мир". Во вкладке "Мир" пролистать опцию "Тип мира" до "МИР-Н", выставить остальные настройки по своему желанию и нажать "Создать новый мир".  
4.1 Если появляется предупреждение о том, что мир использует экспериментальные настройки - нажать "Да";  
![Создание МИРА-Н](readme_assets/create_new_world.png)
![Предупреждение об экспериментальных настройках мира](readme_assets/experimental_world.png)
5. Играйте, как в обычный Майнкрафт и исследуйте безумную новую генерацию.

# Техническая часть

## Подготовка
- Gradle - система сборки, идет в комплекте с Forge.
- [Parchment Mappings](https://parchmentmc.org) - маппинги для функций и полей классов. Исходный код игры подвержен обфускации. ParchmentMC помогает привязать к запутанным именам более понятные и читаемые.
- [Forge Mixins](https://github.com/SpongePowered/Mixin/wiki/Mixins-on-Minecraft-Forge) - миксины. Миксины позволяют вклиниться в методы, описанные в исходном коде игры. 
- [Access Transformers](https://docs.minecraftforge.net/en/1.20.1/advanced/accesstransformers/) - трансформаторы доступа. Позволяют изменять видимость и некоторые другие параметры полей исходного кода игры.
- [HotswapAgent](https://github.com/HotswapProjects/HotswapAgent) - модификация для JDK, которая позволяет производить хотсвап (горячую замену) во время выполнения программы. Нужен для экономии времени при разработке (не перезапускать игру каждый раз). Позволяет менять все, кроме супер-классов. Так же не работает на миксины.
- [JetBrainsRuntime 17](https://github.com/JetBrains/JetBrainsRuntime/releases) - модифицированный вариант JRE, со встроенной поддержкой функционала HotswapAgent'а.
- [Linkie](https://linkie.shedaniel.dev/mappings) - сайт, который помогает написать полное название полей/методов в правильном формате, чтобы использовать в миксинах или трансформаторах доступа.

## Предисловие
  Разобраться в том, как работает генерация мира Майнкрафт мне оказалось довольно нелегко по нескольким причинам:
- Отсутсвие хороших гайдов и подробных объяснений в открытом доступе. Из наиболее полезного могу лишь порекомендовать два видеоматериала от разработчика, который непосредственно занимался созданием текущей системы генерации в игре: [[1]](src/generated/resources/data) [[2]](https://www.youtube.com/watch?v=ob3VwY4JyzE). Но даже там изложены лишь основы, не говоря уже о том, что все примеры представлены довольно абстрактно (в псевдо-коде), без объяснения реализаций;
- Переписывание игры с каждой новой версией. Каждый год разработчики выпускают новую версию, и как оказлось, даже минорные релизы (например переход от 1.20.5 к 1.20.6) могут существенно изменить архитектуру, делая всю существующую документацию к старым версиям неактуальной. Особенно сильный удар пришел в 2021 году с выходом версии 1.18 - в ней принципы генерации миров и способы описания этих принципов изменились до неузнаваемости;
- Не самый простой к прочтению и пониманию код игры;
- Математика... Еще и в json формате...

Для меня единственным способом разобраться, как что работает - стало бесконечное чтение исходного кода игры (который разумеется не задокументирован даже на четверть, а еще и некоторые места в нем так и не были замапенны в ParchmentMC) и тыкаться часами в попытках понять, какая настройка за что отвечает. Многое, даже то, что было задокументировано на википедии, для меня было совершенно нетривиальным и у меня ушли десятки часов на понимание темы.

Львиная доля описаний правил генерации мира передается игре путем дата-паков (наборы .json файлов). Все файлы, описывающие правила и алгоритмы генерации мира находятся в [src/generated/resources/data](src/generated/resources/data). Папки [fogy](src/generated/resources/data/fogy) и [minecraft](src/generated/resources/data/minecraft) представляют собой именные пространства (namepsace).

## Создание нового типа мира
Хороший мод должен быть совместимым с другими. Чтобы достичь совместимости необходимо не изменять существующие типы миров, а создать новый. Новый тип мира создается путем добавления [normal.json](src/generated/resources/data/minecraft/tags/worldgen/world_preset/normal.json). Наличие этого файла подскажет майнкрафту, что нужно загрузить ресурсы генерации мира, находящиеся в именном пространстве fogy.

Описание типа мира хранится в [fogy_world_preset.json](src/generated/resources/data/fogy/worldgen/world_preset/fogy_world_preset.json).
В нем интересующие нас строчки:
```json
  "minecraft:overworld": {
      "type": "fogy:fogy_overworld",
      "generator": {
        "type": "minecraft:noise",
        "biome_source": {
          "type": "minecraft:multi_noise",
          "preset": "minecraft:overworld"
        },
        "settings": "fogy:fogy_noise_settings"
      }
    }
```
а именно:  
`"type": "fogy:fogy_overworld"` - указывает, что тип измерения определен в [fogy_overworld.json](src/generated/resources/data/fogy/dimension_type/fogy_overworld.json)  
` "settings": "fogy:fogy_noise_settings"` - указывать, что настройки шума определны в [fogy_noise_settings.json](src/generated/resources/data/fogy/worldgen/noise_settings/fogy_noise_settings.json)

### Тип измерения
По больше части остался без изменений, за исключением трех строк:  
`"logical_height": 512` - "логическая высота", используется для вычисления места, куда порталы могут перенести игрока в рамках этого измерения;  
`"min_y": -256` - координата y дна измерения;  
`"height": 512` - максимальная высота, считая от дна мира, где можно ставить блоки;  

## Шум и его настройки
