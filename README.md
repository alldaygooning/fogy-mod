# Навгация
1. [Главная](#мод-для-майнкрафта)  
  1.1 [Описание](#описание)  
  1.2 [Требования](#требования)  
  1.3 [Как в это играть?](#как-в-это-играть)
2. [Техническая часть](#техническая часть)  
  2.1 [Подготовка](#подготовка)  
  2.2 [Предисловие](#предисловие)  
  2.3 [Создание нового типа мира](#создание-нового-типа-мира)  
  2.4 [Шум и его настройки](#шум-и-его-настройки)

# Мод для Майнкрафта

## Описание
Мод, добавляющий в Майнкрафт новый тип мира - МИР-Н. В мире МИР-Н полностью изменена генерация ландшафта. МИР-Н состоит из гигантских вертикальных, изрезанных пещерами островов.
![Первый взгляд](readme_assets/mod_preview.png)

### Функционал
- **Переработанный ландшафт** и новое распределение биомов, сохраняющие функционал основной игры (все биомы, структуры, блоки и ресурсы из обычной игры могут натурально сгенерироваться в мире)
  - Многоуровневая генерация растительности всех биомов (раньше растения могли появляться процедурным путем только на поверхности)
  - Увеличена высота верхнего мира (раньше: от -64 до 320, теперь: от -256 до 256)
- Палки теперь работают как зубочистки
- Локализован на русском и английском языках

## Требования
- Майнкрафт Java Edition версии 1.20.1
- [Загрузчик модов Forge](https://files.minecraftforge.net/net/minecraftforge/forge/index_1.20.1.html "Forge") для версии 1.20.1

## Как в это играть?
1. Убедитесь, что все [требования]((#требования) выполнены;
2. Скачать из этого репозитория архив мода последней версии;
3. Установить мод ([как устанавливать моды](https://apexminecrafthosting.com/how-to-install-mods-on-forge/));
4. Перейти в меню "Создать новый мир". Во вкладке "Мир" пролистать опцию "Тип мира" до "МИР-Н", выставить остальные настройки по своему желанию и нажать "Создать новый мир".  
4.1 Если появляется предупреждение о том, что мир использует экспериментальные настройки - нажать "Да";  
![Создание МИРА-Н](readme_assets/create_new_world.png)
![Предупреждение об экспериментальных настройках мира](readme_assets/experimental_world.png)
5. Играйте, как в обычный Майнкрафт и исследуйте безумную новую генерацию.

# Техническая часть

## Подготовка
- Gradle - система сборки, идет в комплекте с Forge.
- [Parchment Mappings](https://parchmentmc.org) - маппинги для функций и полей классов. Исходный код игры подвержен обфускации. ParchmentMC помогает привязать к запутанным именам более понятные и читаемые.
- [Forge Mixins](https://github.com/SpongePowered/Mixin/wiki/Mixins-on-Minecraft-Forge) - миксины. Миксины позволяют вклиниться в методы, описанные в исходном коде игры. 
- [Access Transformers](https://docs.minecraftforge.net/en/1.20.1/advanced/accesstransformers/) - трансформаторы доступа. Позволяют изменять видимость и некоторые другие параметры полей исходного кода игры.
- [HotswapAgent](https://github.com/HotswapProjects/HotswapAgent) - модификация для JDK, которая позволяет производить хотсвап (горячую замену) во время выполнения программы. Нужен для экономии времени при разработке (не перезапускать игру каждый раз). Позволяет менять все, кроме супер-классов. Так же не работает на миксины.
- [JetBrainsRuntime 17](https://github.com/JetBrains/JetBrainsRuntime/releases) - модифицированный вариант JRE, со встроенной поддержкой функционала HotswapAgent'а.
- [Linkie](https://linkie.shedaniel.dev/mappings) - сайт, который помогает написать полное название полей/методов в правильном формате, чтобы использовать в миксинах или трансформаторах доступа.

## Предисловие
  Разобраться в том, как работает генерация мира Майнкрафт мне оказалось довольно нелегко по нескольким причинам:
- Отсутсвие хороших гайдов и подробных объяснений в открытом доступе. Из наиболее полезного могу лишь порекомендовать два видеоматериала от разработчика, который непосредственно занимался созданием текущей системы генерации в игре: [[1]](src/generated/resources/data) [[2]](https://www.youtube.com/watch?v=ob3VwY4JyzE). Но даже там изложены лишь основы, не говоря уже о том, что все примеры представлены довольно абстрактно (в псевдо-коде), без объяснения реализаций;
- Переписывание игры с каждой новой версией. Каждый год разработчики выпускают новую версию, и как оказлось, даже минорные релизы (например переход от 1.20.5 к 1.20.6) могут существенно изменить архитектуру, делая всю существующую документацию к старым версиям неактуальной. Особенно сильный удар пришел в 2021 году с выходом версии 1.18 - в ней принципы генерации миров и способы описания этих принципов изменились до неузнаваемости;
- Не самый простой к прочтению и пониманию код игры;
- Математика... Еще и в json формате...

Для меня единственным способом разобраться, как что работает - стало бесконечное чтение исходного кода игры (который разумеется не задокументирован даже на четверть, а еще и некоторые места в нем так и не были замапенны в ParchmentMC) и тыкаться часами в попытках понять, какая настройка за что отвечает. Многое, даже то, что было задокументировано на википедии, для меня было совершенно нетривиальным и у меня ушли десятки часов на понимание темы.

Львиная доля описаний правил генерации мира передается игре путем дата-паков (наборы .json файлов). Все файлы, описывающие правила и алгоритмы генерации мира находятся в [src/generated/resources/data](src/generated/resources/data). Папки [fogy](src/generated/resources/data/fogy) и [minecraft](src/generated/resources/data/minecraft) представляют собой именные пространства (namepsace).

## Создание нового типа мира
Хороший мод должен быть совместимым с другими. Чтобы достичь совместимости необходимо не изменять существующие типы миров, а создать новый. Новый тип мира создается путем добавления [normal.json](src/generated/resources/data/minecraft/tags/worldgen/world_preset/normal.json). Наличие этого файла подскажет майнкрафту, что нужно загрузить ресурсы генерации мира, находящиеся в именном пространстве fogy.

Описание типа мира хранится в [fogy_world_preset.json](src/generated/resources/data/fogy/worldgen/world_preset/fogy_world_preset.json).
В нем интересующие нас строчки:
```json
  "minecraft:overworld": {
      "type": "fogy:fogy_overworld",
      "generator": {
        "type": "minecraft:noise",
        "biome_source": {
          "type": "minecraft:multi_noise",
          "preset": "minecraft:overworld"
        },
        "settings": "fogy:fogy_noise_settings"
      }
    }
```
а именно:  
`"type": "fogy:fogy_overworld"` - указывает, что тип измерения определен в [fogy_overworld.json](src/generated/resources/data/fogy/dimension_type/fogy_overworld.json);  
` "settings": "fogy:fogy_noise_settings"` - указывать, что настройки шума определны в [fogy_noise_settings.json](src/generated/resources/data/fogy/worldgen/noise_settings/fogy_noise_settings.json);

### Тип измерения
По больше части остался без изменений, за исключением трех строк:  
`"logical_height": 512` - "логическая высота", используется для вычисления места, куда порталы могут перенести игрока в рамках этого измерения, например, в аду логическая высота меньше, чем высота строительства - поэтому порталы над потолком ада строить можно, но ни один портал не переместит игрока в пространство над потолком;  
`"min_y": -256` - координата y дна измерения;  
`"height": 512` - максимальная высота, считая от дна мира, где можно ставить блоки;  

## Шум и его настройки
Шум - пожалуй, самая важная концепция в этой теме. Вся генерация Майнкрафта завязана на шуме, а именно на трехмерном шуме Перлина. Все использованные мной шумы расположены в [noise](src/generated/resources/data/fogy/worldgen/noise). У шума Перлина есть такие настройки, как амплитуды (параметер amplitudes) и октавы (задается с помощью первой октавы - firstOctave). Не вдаваясь глубоко в вычисления:  
- Больше амплитуд = больше шумовых пятен
- Больше значение амплитуды = более зернистый шум
- Больше значение первой октавы = более мелкие шумовые пятна
Шум Перлина в Майнкрафте именно трехмерный (это следует понять, потому что большая часть инструментов, визуализирующих шум Перлина, представляют его в виде двумерной карты - поэтому такой шум на картинке и в игре будет сильно отличаться!).

Смысл всех настроек в [fogy_noise_settings.json](src/generated/resources/data/fogy/worldgen/noise_settings/fogy_noise_settings.json) понятен из их названия, за исключением двух: `noise_router` и `surface_rule`.

### Noise Router
`noise_router` состоит из набора функций плотности. Функции плотности могут быть описаны как внутри [fogy_noise_settings.json](src/generated/resources/data/fogy/worldgen/noise_settings/fogy_noise_settings.json), так и в файлах внутри [density_function](src/generated/resources/data/fogy/worldgen/density_function). Функция плотности - это функция, которая по результату некоторых математических операций (обычно над шумом или градиентом) возвращает одно значение (обычно число с плавающей запятой от -1 до 1). Каждый ключ в `noise_router` отвечает за поределенную настройку генерации ландшафта.
#### Final Density
Главная функция плотности. Рассчитывается для каждого набора координат (x, y, z) в мире.  
Если для набора координат это функция возвращает положительное значение - на этих координатах будет стоять `default_block`, если же неположительное - блок воздуха (`minecraft:air`). Поскольку это ключевая функция в создании ландшафта, то разберу её подробно:

```
"final_density": {
      "type": "minecraft:add", (5)
      "argument1": {
        "type": "minecraft:range_choice", (4)
        "input": {
          "type": "minecraft:add", (3)
          "argument1": "fogy:overworld/terrain/island_stem" (2),
          "argument2": "fogy:overworld/terrain/island_cheese" (1)
        },
        "min_inclusive": 2,
        "max_exclusive": 2.001,
        "when_in_range": 1,
        "when_out_of_range": 0
      },
      "argument2": "fogy:overworld/terrain/floor"
    }
```
1. [island_cheese](src/generated/resources/data/fogy/worldgen/density_function/terrain/island_cheese.json) - функция плотности, которая генерирует вырезанные пещеры. Выглядит следующим образом:
```
{
	"type": "minecraft:range_choice", (3)
	"input": {
		"type": "minecraft:clamp", (2)
		"input": {
			"type": "minecraft:noise", (1)
			"noise": "fogy:island_cheese",
			"xz_scale": 2,
			"y_scale": 2
		},
		"min": -1,
		"max": 1
	},
	"min_inclusive": 0,
	"max_exclusive": 1.001,
	"when_in_range": 1,
	"when_out_of_range": 0
}
```
1.1 Берется шум (зернистости и плотности, которой я выбрал), растягивается горизонтально и вертикально в два раза (чтобы увеличить объем пещер).  
1.2 В каждой своей точке этот шум принимает какие-то значения. Чтобы получить значения, с которыми удобно работать - шум нормализуется. Все его значения от меньшего к большему линейно сопоставляются значениям от -1 до 1.  
1.3 Если значение шума в точке от 0 до 1, то назначить значение в этой точке - 1, в противном случае - 0. 

То есть эта функция плотности производит шум, который наполняет весь мир случайными пещерами.
![Демонстрация пещерной генерации](readme_assets/island_cheese_fly.mp4)
2. [island_stem](src/generated/resources/data/fogy/worldgen/density_function/terrain/island_stem.json) - функция плотности, которая генерирует высокие столбы в форме пятен. Выглядит следующим образом:
```
{
  "type": "minecraft:range_choice",
  "input": {
    "type": "minecraft:add",
    "argument1": {
      "type": "minecraft:clamp", (2)
      "input": {
        "type": "minecraft:noise", (1)
        "noise": "fogy:islands",
        "xz_scale": 1,
        "y_scale": 0
      },
      "min": -1,
      "max": 1
    },
    "argument2": "fogy:overworld/terrain/ceiling" (3)
  },
  "min_inclusive": 0.001,
  "max_exclusive": 1.001,
  "when_in_range": 1,
  "when_out_of_range": 0
}
```
2.1 Берется шум (зернистости и плотности, которой я выбрал) и к нему применяется интересный трюк: в горизонтальной плоскости шум растягивается в 1 раз (то есть не изменяется), а в вертикальной - в 0 раз. Это значит, что значение шума в игре для любой координаты y будет равным y*0, то есть 0, а значит, что для любых блоков с координатами (x, z) значение шума будет одинаковым от дна до полотка мира (равное значению, полученному на нулевом уровне мира). Получается двумерный шум.  
2.2 Шум нормализуется.  
2.3 К шуму прибавляется значение функции плотности [ceiling](src/generated/resources/data/fogy/worldgen/density_function/terrain/ceiling.json):  
```
{
  "type": "minecraft:range_choice", (4)
  "input": {
    "type": "minecraft:add", (3)
    "argument1": {
      "type": "minecraft:y_clamped_gradient", (1)
      "from_y": -256,
      "to_y": 256,
      "from_value": 10,
      "to_value": -0.25
    },
    "argument2": {
      "type": "minecraft:noise", (2)
      "noise": "minecraft:gravel",
      "xz_scale": 2,
      "y_scale": 0
    }
  },
  "min_inclusive": -10000,
  "max_exclusive": 1,
  "when_in_range": -1,
  "when_out_of_range": 0
}
```
2.3.1 Берется градиент от дна до потолка мира, где каждому набору координат (x, y, z) присваивается значение от 10 до -0.25. То есть чем выше блок, тем ниже его значение.  
2.3.2 Берется двумерный шум.
2.3.3 Градиент и шум складываются, и получается, случайный узор:
![Функция плотности потолка](readme_assets/ceiling_density_function.png)  
Чем темнее значение - тем оно выше. Белые значения - отрицательные.
2.3.4 Если значение меньше 1, то вернуть -1, в противном случае - 0.
![Нормализованная функция плотности потолка](readme_assets/ceiling_density_function_norm.png)  
Белые пиксели соответсвуют значению -1, а серые 0.  
Поскольку значения island_stem нормализованы от -1 до 1, сложение с этой функцией приведет к тому, что белые пиксели "занулят" верхушку мира. 
2.4 Если значение шума в точке от 0 до 1, то назначить значение в этой точке - 1, в противном случае - 0.   
3. Для каждого блока в мире значения функций плотности island_stem и island_cheese складываются.  
4. Логика простая: мы знаем, что island_stem и island_cheese возвращают либо 0, либо 1. То есть их сумма может быть 0, 1 или 2. Если для блока сумма этих двух функций 0 - значит, ни одна функция не посчитала нужным поставить этот блок, если 1 - только одна из функций установила этот блок в твердое состояние, а если 2 - обе функции поставили на этих координатах твердый блок (Да, логику можно было существенно упростить, использовав умножение, но об этом я догадался только сейчас). То есть, чтобы получить одновременно и острова, и пещеры - надо все блоки, для которых функция плотности не равна 2 занулить.  

Генерация одного и того же мира для разных этапов:
1. Только пещеры
![Пещеры](readme_assets/cheese_up.png)
2. Только острова
![Острова](readme_assets/stem_up.png)
3. Только острова, но уже с вырезанным потолком
![Острова с потолком](readme_assets/stem_ceil_up.png)
4. Готовые острова с пещерами
![Острова с пещерами](readme_assets/terrain_up.png)

### Surface Rule
